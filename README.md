# Authentication Flow Documentation (Next.js + JWT + Role-based Access Control)

## ЁЯУМ р╕ар╕▓р╕Юр╕гр╕зр╕бр╕Вр╕нр╕Зр╕гр╕░р╕Ър╕Ъ

р╣Вр╕Др╕гр╕Зр╕Бр╕▓р╕гр╕Щр╕╡р╣Йр╣Ар╕Ыр╣Зр╕Щр╕гр╕░р╕Ър╕Ъ **Authentication р╣Бр╕ер╕░ Authorization** р╕Чр╕╡р╣Ир╕гр╕нр╕Зр╕гр╕▒р╕Ъ **Role-based Access Control (RBAC)** р╣Вр╕Фр╕вр╕бр╕╡ 3 р╕гр╕░р╕Фр╕▒р╕Ър╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕З:
- **User** тЖТ р╕бр╕╡р╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Юр╕╖р╣Йр╕Щр╕Рр╕▓р╕Щ
- **Manager** тЖТ р╕бр╕╡р╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ър╕▓р╕Зр╕кр╣Ир╕зр╕Щ
- **Admin** тЖТ р╕бр╕╡р╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕Др╕зр╕Ър╕Др╕╕р╕бр╕гр╕░р╕Ър╕Ър╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф

---

## ЁЯФ╣ **р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕┤р╕Чр╕Шр╕┤р╣М (Authentication Flow)**

### **1. р╕Бр╕гр╕░р╕Ър╕зр╕Щр╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ъ (Login Process)**
```mermaid
sequenceDiagram
    Frontend->>+Backend: POST /api/auth/login
    Note right of Frontend: {username, password}
    Backend->>Backend: р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Др╕зр╕▓р╕бр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╕Вр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е
    Backend->>Backend: р╕кр╕гр╣Йр╕▓р╕З JWT Token
    Backend-->>-Frontend: р╕кр╣Ир╕Зр╕Др╕╖р╕Щ {token, role}
    Frontend->>Frontend: р╣Ар╕Бр╣Зр╕Ъ token р╣Гр╕Щ localStorage
    Frontend->>Frontend: Redirect р╣Др╕Ыр╕лр╕Щр╣Йр╕▓р╕Хр╕▓р╕б Role
```

### **2. р╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╣Гр╕Кр╣Йр╕кр╕┤р╕Чр╕Шр╕┤р╣М (Protected Route Access)**
```mermaid
sequenceDiagram
    Frontend->>Frontend: р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡ Token р╕лр╕гр╕╖р╕нр╣Др╕бр╣И
    Frontend->>+Backend: GET /api/{role endpoint}
    Note right of Frontend: р╕кр╣Ир╕З token р╣Гр╕Щ Header
    Backend->>Backend: р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ JWT Token
    Backend->>Backend: р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕Вр╕нр╕З Role
    Backend-->>-Frontend: р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕ер╕▒р╕Ъ р╕лр╕гр╕╖р╕н 403 Forbidden
```

---

## ЁЯФ╣ **API Endpoints р╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╣Гр╕Щр╕гр╕░р╕Ър╕Ъ**

### **ЁЯУМ р╕Бр╕▓р╕гр╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Хр╕▒р╕зр╕Хр╕Щ (Authentication API)**
| Method | Endpoint | р╕Др╕│р╕нр╕Шр╕┤р╕Ър╕▓р╕в |
|--------|---------|----------|
| `POST` | `/api/auth/login` | р╣Гр╕Кр╣Йр╕кр╕│р╕лр╕гр╕▒р╕Ър╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ъ |
| `GET` | `/api/auth/sso` | р╕гр╕нр╕Зр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ър╕Ьр╣Ир╕▓р╕Щ Keycloak SSO |

**ЁЯУМ р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З Request (`POST /api/auth/login`)**
```json
{
  "username": "user1",
  "password": "password"
}
```
**ЁЯУМ р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З Response**
```json
{
  "token": "eyJhbGciOiJIUz...",
  "role": "user"
}
```

---

## ЁЯФ╣ **Frontend Routes (р╣Ар╕кр╣Йр╕Щр╕Чр╕▓р╕Зр╕Вр╕нр╕Зр╕лр╕Щр╣Йр╕▓р╣Ар╕зр╣Зр╕Ъ)**

| Route | р╕Др╕│р╕нр╕Шр╕┤р╕Ър╕▓р╕в | р╕Ьр╕╣р╣Йр╕Чр╕╡р╣Ир╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╣Др╕Фр╣Й |
|--------|---------|----------------|
| `/login` | р╕лр╕Щр╣Йр╕▓р╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ъ | р╕Чр╕╕р╕Бр╕Др╕Щ |
| `/dashboard` | Dashboard р╕Юр╕╖р╣Йр╕Щр╕Рр╕▓р╕Щ | User, Manager, Admin |
| `/manager` | Dashboard р╕Ьр╕╣р╣Йр╕Ир╕▒р╕Фр╕Бр╕▓р╕г | Manager, Admin |
| `/admin` | Dashboard р╕Ьр╕╣р╣Йр╕Фр╕╣р╣Бр╕ер╕гр╕░р╕Ър╕Ъ | Admin р╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ |

---

## ЁЯФ╣ **р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╕Вр╕нр╕З Authentication**

### **ЁЯУМ р╣Гр╕Кр╣Й `useAuth` Hook р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕┤р╕Чр╕Шр╕┤р╣М**
```typescript
// р╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щр╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╣Гр╕Кр╣Йр╕кр╕┤р╕Чр╕Шр╕┤р╣М
useAuth(requiredRole?: string)

// р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ
useAuth("admin") // р╕нр╕Щр╕╕р╕Нр╕▓р╕Хр╣Гр╕лр╣Йр╣Ар╕Йр╕Юр╕▓р╕░ Admin р╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ
useAuth() // р╕нр╕Щр╕╕р╕Нр╕▓р╕Хр╣Гр╕лр╣Йр╕Чр╕╕р╕Бр╕Др╕Щр╕Чр╕╡р╣Ир╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ър╣Бр╕ер╣Йр╕з
```

### **ЁЯУМ р╣Гр╕Кр╣Й Middleware р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Role р╕Ър╕Щ Backend**
```typescript
// р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Role р╣Бр╕ер╕░р╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕Вр╕нр╕З API
authorizeRole(allowedRoles: string[], request: NextRequest)
```

---

## ЁЯФ╣ **р╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╣Ар╕Бр╣Зр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щ Local Storage**
р╕лр╕ер╕▒р╕Зр╕Ир╕▓р╕Бр╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ър╕кр╕│р╣Ар╕гр╣Зр╕И **Frontend** р╕Ир╕░р╣Ар╕Бр╣Зр╕Ър╕Др╣Ир╕▓р╕Хр╣Ир╕нр╣Др╕Ыр╕Щр╕╡р╣Йр╣Др╕зр╣Й:
| Key | р╕Др╕│р╕нр╕Шр╕┤р╕Ър╕▓р╕в |
|------|----------|
| `token` | JWT Token р╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Хр╕▒р╕зр╕Хр╕Щ |
| `role` | р╕Ър╕Чр╕Ър╕▓р╕Чр╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й р╣Ар╕Кр╣Ир╕Щ `"user"`, `"manager"`, `"admin"` |

---

## ЁЯФ╣ **р╕бр╕▓р╕Хр╕гр╕Бр╕▓р╕гр╕Фр╣Йр╕▓р╕Щр╕Др╕зр╕▓р╕бр╕Ыр╕ер╕нр╕Фр╕ар╕▒р╕в (Security Features)**

### **1. JWT Authentication**
тЬЕ **р╣Гр╕Кр╣Й JWT р╕кр╕│р╕лр╕гр╕▒р╕Ър╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Хр╕▒р╕зр╕Хр╕Щ**  
тЬЕ **Token р╕бр╕╡р╕зр╕▒р╕Щр╕лр╕бр╕Фр╕нр╕▓р╕вр╕╕** (р╣Ар╕Кр╣Ир╕Щ 1 р╕Кр╕▒р╣Ир╕зр╣Вр╕бр╕З)  
тЬЕ **Token р╕Цр╕╣р╕Бр╕кр╣Ир╕Зр╣Гр╕Щ Header (`Authorization: Bearer <token>`)**  

### **2. Role-based Access Control**
тЬЕ **Frontend р╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щр╣Др╕бр╣Ир╣Гр╕лр╣Йр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣Ир╣Др╕бр╣Ир╕бр╕╡р╕кр╕┤р╕Чр╕Шр╕┤р╣М**  
тЬЕ **Backend р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Role р╕Бр╣Ир╕нр╕Щр╣Гр╕лр╣Йр╕Вр╣Йр╕нр╕бр╕╣р╕е**  
тЬЕ **р╕бр╕╡р╕ер╕│р╕Фр╕▒р╕Ър╕Кр╕▒р╣Йр╕Щр╕Вр╕нр╕Зр╕кр╕┤р╕Чр╕Шр╕┤р╣М (Hierarchy)**  

### **3. API Security**
тЬЕ **р╕Чр╕╕р╕Б API Route р╕Хр╣Йр╕нр╕Зр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ JWT Token**  
тЬЕ **Role Validation р╣Гр╕Щр╕Чр╕╕р╕Бр╕Др╕│р╕Вр╕н**  
тЬЕ **р╕лр╕▓р╕Бр╣Др╕бр╣Ир╕бр╕╡р╕кр╕┤р╕Чр╕Шр╕┤р╣М р╕Ир╕░р╕кр╣Ир╕З HTTP `403 Forbidden`**  

---

## ЁЯФ╣ **р╕Ър╕▒р╕Нр╕Кр╕╡р╕Чр╕Фр╕кр╕нр╕Ър╕кр╕│р╕лр╕гр╕▒р╕Ър╕Щр╕▒р╕Бр╕Юр╕▒р╕Тр╕Щр╕▓ (Dev Credentials)**

р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ър╕гр╕░р╕Ър╕Ъ р╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Гр╕Кр╣Йр╕Ър╕▒р╕Нр╕Кр╕╡р╕Хр╣Ир╕нр╣Др╕Ыр╕Щр╕╡р╣Й:

```json
[
  { "username": "user1", "password": "password", "role": "user" },
  { "username": "manager1", "password": "password", "role": "manager" },
  { "username": "admin1", "password": "password", "role": "admin" }
]
```

---

## ЁЯОп **р╕кр╕гр╕╕р╕Ы**
тЬЕ р╕гр╕░р╕Ър╕Ър╕гр╕нр╕Зр╕гр╕▒р╕Ъ **Authentication + JWT**  
тЬЕ р╕гр╕░р╕Ър╕Ър╕гр╕нр╕Зр╕гр╕▒р╕Ъ **Role-based Authorization**  
тЬЕ р╕бр╕╡р╕Бр╕▓р╕гр╣Бр╕вр╕Б **р╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕Вр╕нр╕З User, Manager р╣Бр╕ер╕░ Admin**  
тЬЕ р╕бр╕╡р╕Бр╕▓р╕гр╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щ **API & Frontend Route** р╕Хр╕▓р╕б Role  
тЬЕ р╕гр╕нр╕Зр╕гр╕▒р╕Ъ **Keycloak SSO**  

ЁЯФе **р╕гр╕░р╕Ър╕Ър╕Юр╕гр╣Йр╕нр╕бр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ р╣Бр╕ер╕░р╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Вр╕вр╕▓р╕вр╕Хр╣Ир╕нр╣Др╕Фр╣Й ЁЯОЙ**
